#include <stdio.h>
#include <stdlib.h>
#include <pico/stdlib.h>
#include <pico/multicore.h>
#include <hardware/clocks.h>
#include <hardware/irq.h>
#include <hardware/sync.h>
#include <hardware/vreg.h>
#include <pico/sem.h>
#include <FreeRTOS.h>
#include <task.h>
#include "frame.h"
#include "led.h"
#include "uart.h"
#include "usb.h"

static const frame_t start = {
    .data =
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0xf8, 0xc0, 0x00, 0xf8, 0xf8, 0x00, 0xc0, 0xf8,
            0x38, 0x00, 0x40, 0xa0, 0xa0, 0xe0, 0xc0, 0x00, 0x00, 0xe8, 0xe8, 0x00, 0x20, 0xf8,
            0xf8, 0x20, 0x00, 0xe8, 0xe8, 0x00, 0xe0, 0xc0, 0x20, 0xe0, 0xc0, 0x00, 0xc0, 0xe0,
            0x20, 0xc0, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x20, 0xf0, 0xf8, 0x28, 0x08, 0x00, 0xc0,
            0xe0, 0x20, 0xe0, 0xc0, 0x00, 0xe0, 0xc0, 0x60, 0x20, 0x00, 0x00, 0x00, 0xe0, 0xf0,
            0x18, 0x08, 0x08, 0x18, 0x30, 0x00, 0xc0, 0xe0, 0x20, 0xe0, 0xc0, 0x00, 0xe0, 0xc0,
            0x20, 0xe0, 0xc0, 0x00, 0xe0, 0xc0, 0x20, 0xe0, 0xc0, 0x00, 0xc0, 0xe0, 0xa0, 0xe0,
            0xc0, 0x00, 0xc0, 0xe0, 0x20, 0x60, 0x00, 0x20, 0xf8, 0xf8, 0x20, 0x00, 0xe8, 0xe8,
            0x00, 0xc0, 0xe0, 0x20, 0xe0, 0xc0, 0x00, 0xe0, 0xc0, 0x20, 0xe0, 0xc0, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x07, 0x01, 0x01, 0x07,
            0x07, 0x01, 0x00, 0x00, 0x83, 0x87, 0x84, 0x03, 0x07, 0x04, 0x00, 0x07, 0x07, 0x00,
            0x00, 0x03, 0x07, 0x04, 0x00, 0x07, 0x07, 0x00, 0x07, 0x07, 0x00, 0x07, 0x07, 0x00,
            0x03, 0x17, 0x14, 0x1f, 0x0f, 0x00, 0x00, 0x80, 0x00, 0x00, 0x07, 0x07, 0x00, 0x80,
            0x00, 0x03, 0x07, 0x04, 0x07, 0x03, 0x00, 0x07, 0x07, 0x80, 0x80, 0x80, 0x80, 0x80,
            0x01, 0x83, 0x06, 0x84, 0x04, 0x06, 0x03, 0x00, 0x03, 0x07, 0x04, 0x07, 0x03, 0x00,
            0x07, 0x07, 0x00, 0x07, 0x07, 0x00, 0x07, 0x07, 0x00, 0x07, 0x07, 0x00, 0x83, 0x87,
            0x84, 0x86, 0x82, 0x00, 0x03, 0x07, 0x04, 0x06, 0x00, 0x00, 0x03, 0x07, 0x04, 0x00,
            0x07, 0x07, 0x00, 0x03, 0x07, 0x04, 0x07, 0x03, 0x00, 0x07, 0x07, 0x00, 0x07, 0x07,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x20, 0x20, 0x20, 0x11, 0x00, 0x1c, 0x22, 0x22,
            0x1c, 0x00, 0x3e, 0x02, 0x02, 0x3c, 0x00, 0x3e, 0x02, 0x02, 0x3c, 0x00, 0x1c, 0x2a,
            0x2a, 0x0c, 0x00, 0x1c, 0x22, 0x22, 0x14, 0x00, 0x02, 0x3f, 0x02, 0x00, 0x00, 0x00,
            0x02, 0x3f, 0x02, 0x00, 0x1c, 0x22, 0x22, 0x1c, 0x00, 0x00, 0x00, 0x3f, 0x04, 0x04,
            0x04, 0x00, 0x00, 0x3f, 0x00, 0x3e, 0x00, 0xfe, 0x22, 0x22, 0x1c, 0x00, 0xfe, 0x22,
            0x22, 0x1c, 0x00, 0x1c, 0x2a, 0x2a, 0x0c, 0x00, 0x3e, 0x02, 0x02, 0x00, 0x00, 0x00,
            0x30, 0x28, 0x24, 0x22, 0x21, 0x00, 0x1c, 0x2a, 0x2a, 0x0c, 0x00, 0x3e, 0x02, 0x02,
            0x00, 0x1c, 0x22, 0x22, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x10, 0x10, 0xe0,
            0x00, 0xf0, 0x10, 0x10, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0xf0, 0x00, 0xf0, 0x10,
            0x10, 0xe0, 0x00, 0xe0, 0x10, 0x10, 0xfc, 0x00, 0xe0, 0x10, 0x10, 0xf0, 0x00, 0x10,
            0xfc, 0x10, 0x00, 0xe0, 0x50, 0x50, 0x60, 0x00, 0x00, 0x00, 0xf4, 0x00, 0x10, 0xfc,
            0x10, 0x00, 0x20, 0x50, 0x90, 0x00, 0x00, 0x00, 0xf8, 0x24, 0x00, 0xf4, 0x00, 0xf0,
            0x10, 0x10, 0x00, 0xf0, 0x10, 0x10, 0xe0, 0x10, 0x10, 0xe0, 0x00, 0xf0, 0x00, 0x00,
            0xf0, 0x00, 0x00, 0xf0, 0x00, 0xe0, 0x10, 0x10, 0xf0, 0x00, 0xf0, 0x10, 0x10, 0x00,
            0xe0, 0x50, 0x50, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
            0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00,
            0x07, 0x01, 0x01, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01,
            0x00, 0x00, 0x01, 0xe0, 0x20, 0xa0, 0xa1, 0xa1, 0x20, 0xe0, 0x00, 0xa0, 0x21, 0x40,
            0xe0, 0x81, 0xa0, 0xc0, 0x01, 0x21, 0x00, 0xe0, 0x20, 0xa0, 0xa1, 0xa0, 0x20, 0xe1,
            0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00,
            0x01, 0x01, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x01, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x2f, 0xa8, 0xab, 0xeb, 0xcb, 0x08, 0xaf, 0x80, 0xeb,
            0x57, 0x08, 0xe1, 0x1f, 0x05, 0xf9, 0x12, 0x7e, 0xe0, 0x0f, 0xc8, 0xab, 0x2b, 0x2b,
            0x48, 0x2f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x8c, 0x9a, 0x94, 0xaf, 0x90, 0xaa,
            0x15, 0x45, 0xd2, 0x6c, 0x53, 0xcb, 0xeb, 0x5e, 0x15, 0xf0, 0x2e, 0xb6, 0x36, 0xfe,
            0x21, 0xeb, 0xaa, 0xf6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x20, 0x2e, 0x2e, 0x2e,
            0x20, 0x3f, 0x00, 0x3c, 0x15, 0x34, 0x0c, 0x3a, 0x3c, 0x2f, 0x1d, 0x03, 0x2e, 0x2e,
            0x22, 0x3f, 0x26, 0x3c, 0x2f, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00,
        },
};

frame_t noise = {0};

void init() {
    sleep_ms(10);
    vreg_set_voltage(frame_get_voltage());

    sleep_ms(10);
    set_sys_clock_khz(frame_get_clock(), true);
    
    stdio_init_all();
    frame_init();
    led_init();
    usb_init();
    uart_protocol_init();
}

void led_task(void* unused_arg) {
    while(1) {
        led_red(true);
        vTaskDelay(pdMS_TO_TICKS(500));
        led_red(false);
        vTaskDelay(pdMS_TO_TICKS(500));
    }
}

int main() {
    init();

    frame_parse_data(OrientationHorizontal, &start, 1000);

    BaseType_t status;

    TaskHandle_t led_task_handle = NULL;
    status = xTaskCreate(led_task, "led_task", 128, NULL, 1, &led_task_handle);
    assert(status == pdPASS);
    (void)status;

    // TaskHandle_t frame_task_handle = NULL;
    // status = xTaskCreate(frame_task, "frame_task", 128, NULL, 1, &frame_task_handle);
    // assert(status == pdPASS);

    vTaskStartScheduler();

    while(1) __wfe();
    __builtin_unreachable();
}
